  # Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
  # More GitHub Actions for Azure: https://github.com/Azure/actions
  # More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

  name: Build and deploy Python app to Azure Web App - corp-dashboard

  on:
    push:
      branches:
        - main
    workflow_dispatch:

  jobs:
    build:
      runs-on: ubuntu-latest
      permissions:
        contents: read

      steps:
        - name: Check workflow start
          run: echo "Workflow started, checking environment"

        - uses: actions/checkout@v4

        - name: Set up Python version
          uses: actions/setup-python@v5
          with:
            python-version: '3.10'

        - name: Install dependencies
          run: |
            pip install --target=.python_packages/lib/python3.10/site-packages \
              dash==2.17.1 \
              pandas==2.2.2 \
              requests==2.32.3 \
              plotly==5.22.0 \
              dash-bootstrap-components==1.6.0 \
              gunicorn==22.0.0 \
              pyodbc==5.1.0 \
              diskcache==5.6.3 \
              redis==5.0.8

        - name: Debug directory after installation
          run: ls -la .python_packages/lib/python3.10/site-packages || echo "Directory not found"

        - name: Zip artifact
          run: zip -r python-app.zip . .python_packages

        - name: Upload artifact for deployment jobs
          uses: actions/upload-artifact@v4
          with:
            name: python-app
            path: python-app.zip

    deploy:
      runs-on: ubuntu-latest
      needs: build
      permissions:
        id-token: write
        contents: read

      steps:
        - name: Download artifact from build job
          uses: actions/download-artifact@v4
          with:
            name: python-app

        - name: Debug artifact contents
          run: unzip -l python-app.zip || echo "Artifact zip not found"

        - name: Login to Azure
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: 'Deploy to Azure Web App'
          uses: azure/webapps-deploy@v3
          id: deploy-to-webapp
          with:
            app-name: 'corp-dashboard'
            slot-name: 'Production'
            package: python-app.zip
